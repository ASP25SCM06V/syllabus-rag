<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syllabus RAG ‚Äî Ask Your Syllabus</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #161a22;
    --border: #1e2330;
    --accent: #00e5a0;
    --accent2: #0066ff;
    --text: #e8eaf0;
    --muted: #5a6070;
    --chunk-bg: #0d1117;
    --chunk-border: #1a2535;
    --error: #ff6b6b;
    --warning: #ffb347;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,160,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,160,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    position: relative;
    z-index: 1;
  }

  /* ---- HEADER ---- */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0,229,160,0.08);
    border: 1px solid rgba(0,229,160,0.2);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    margin-bottom: 20px;
    letter-spacing: 0.08em;
  }

  .badge-dot {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  h1 {
    font-family: 'Space Mono', monospace;
    font-size: clamp(26px, 5vw, 40px);
    font-weight: 700;
    line-height: 1.15;
    margin-bottom: 12px;
  }

  h1 span { color: var(--accent); }

  .subtitle {
    color: var(--muted);
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 32px;
  }

  /* ---- SERVER STATUS ---- */
  .server-status {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 28px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    border: 1px solid;
    transition: all 0.3s ease;
  }

  .server-status.checking { background: rgba(90,96,112,0.1); border-color: var(--border); color: var(--muted); }
  .server-status.online   { background: rgba(0,229,160,0.07); border-color: rgba(0,229,160,0.25); color: var(--accent); }
  .server-status.offline  { background: rgba(255,107,107,0.07); border-color: rgba(255,107,107,0.25); color: var(--error); }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .checking .status-dot { background: var(--muted); }
  .online   .status-dot { background: var(--accent); animation: pulse 2s infinite; }
  .offline  .status-dot { background: var(--error); }

  /* ---- UPLOAD ZONE ---- */
  .upload-section {
    margin-bottom: 32px;
  }

  .section-label {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 36px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--surface);
    position: relative;
  }

  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(0,229,160,0.04);
  }

  .drop-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .drop-icon { font-size: 32px; margin-bottom: 12px; }

  .drop-text {
    font-size: 15px;
    color: var(--text);
    margin-bottom: 6px;
    font-weight: 500;
  }

  .drop-subtext {
    font-size: 13px;
    color: var(--muted);
  }

  .drop-subtext span {
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
  }

  /* upload progress */
  .upload-progress {
    display: none;
    margin-top: 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }

  .progress-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
  }

  .progress-filename { color: var(--text); }
  .progress-status { color: var(--muted); }

  .progress-bar-track {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    width: 0%;
    transition: width 0.4s ease;
  }

  .progress-steps {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .progress-step {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 3px;
    border: 1px solid var(--border);
    color: var(--muted);
    transition: all 0.3s ease;
  }

  .progress-step.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.07); }
  .progress-step.done   { border-color: rgba(0,229,160,0.3); color: rgba(0,229,160,0.5); }

  /* loaded file banner */
  .loaded-file {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    background: rgba(0,229,160,0.06);
    border: 1px solid rgba(0,229,160,0.2);
    border-radius: 8px;
    margin-top: 12px;
  }

  .loaded-file.visible { display: flex; }

  .file-icon { font-size: 20px; }

  .file-info { flex: 1; }
  .file-name { font-weight: 600; font-size: 14px; color: var(--text); }
  .file-meta { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); margin-top: 2px; }

  .change-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .change-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* ---- STATS ---- */
  .stats-bar {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    margin-bottom: 32px;
    padding: 16px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .stat { display: flex; flex-direction: column; gap: 2px; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }

  /* ---- Q&A SECTION ---- */
  .qa-section { display: none; }
  .qa-section.visible { display: block; }

  .suggested { margin-bottom: 24px; }

  .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

  .chip {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    padding: 7px 14px;
    border-radius: 100px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .chip:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.05); }

  .query-section { position: relative; margin-bottom: 28px; }

  textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    padding: 16px 20px 56px;
    resize: none;
    outline: none;
    line-height: 1.6;
    transition: border-color 0.2s;
    min-height: 100px;
  }

  textarea::placeholder { color: var(--muted); }
  textarea:focus { border-color: rgba(0,229,160,0.4); box-shadow: 0 0 0 3px rgba(0,229,160,0.06); }

  .query-footer {
    position: absolute;
    bottom: 12px; right: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .char-count { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }

  .ask-btn {
    background: var(--accent);
    color: #000;
    border: none;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.04em;
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .ask-btn:hover:not(:disabled) { background: #00ffb3; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,229,160,0.3); }
  .ask-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .spinner {
    width: 12px; height: 12px;
    border: 2px solid rgba(0,0,0,0.3);
    border-top-color: #000;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: none;
  }

  .ask-btn.loading .spinner { display: block; }
  .ask-btn.loading .btn-text { display: none; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ---- RESULT ---- */
  #result-area { display: none; }

  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .result-label { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

  .pipeline-steps { display: flex; align-items: center; gap: 6px; font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }

  .step { padding: 3px 8px; border-radius: 3px; border: 1px solid var(--border); transition: all 0.3s ease; }
  .step.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.07); }
  .step.done   { border-color: rgba(0,229,160,0.3); color: rgba(0,229,160,0.5); }
  .step-arrow  { color: var(--muted); }

  .answer-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 20px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .answer-text { font-size: 16px; line-height: 1.7; }

  .chunks-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 7px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    margin-bottom: 12px;
  }

  .chunks-toggle:hover { border-color: var(--accent2); color: var(--text); }
  .chunks-toggle .arrow { transition: transform 0.2s; }
  .chunks-toggle.open .arrow { transform: rotate(90deg); }

  .chunks-list { display: none; flex-direction: column; gap: 10px; }
  .chunks-list.visible { display: flex; }

  .chunk-card { background: var(--chunk-bg); border: 1px solid var(--chunk-border); border-radius: 8px; padding: 14px 16px; animation: slideIn 0.2s ease both; }
  .chunk-card:nth-child(2) { animation-delay: 0.05s; }

  .chunk-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }

  .chunk-num { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--accent2); background: rgba(0,102,255,0.1); border: 1px solid rgba(0,102,255,0.2); padding: 2px 8px; border-radius: 3px; }

  .similarity-bar { display: flex; align-items: center; gap: 8px; font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }
  .bar-track { width: 60px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease 0.2s; }

  .chunk-text { font-size: 13px; color: var(--muted); line-height: 1.6; font-family: 'Space Mono', monospace; }

  .error-msg { background: rgba(255,60,60,0.08); border: 1px solid rgba(255,60,60,0.2); color: var(--error); font-size: 14px; padding: 14px 18px; border-radius: 8px; font-family: 'Space Mono', monospace; line-height: 1.6; }

  /* ---- HOW IT WORKS ---- */
  .how-it-works { margin-top: 48px; padding-top: 32px; border-top: 1px solid var(--border); }
  .flow { display: flex; flex-wrap: wrap; }
  .flow-step { flex: 1; min-width: 130px; padding: 16px; position: relative; }
  .flow-step:not(:last-child)::after { content: '‚Üí'; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }
  .flow-icon { font-size: 22px; margin-bottom: 8px; }
  .flow-step-name { font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; color: var(--accent); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.04em; }
  .flow-step-desc { font-size: 12px; color: var(--muted); line-height: 1.5; }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div style="margin-bottom:40px">
    <div class="badge"><span class="badge-dot"></span> RAG SYSTEM</div>
    <h1>Ask Your <span>Syllabus</span></h1>
    <p class="subtitle">Upload any course syllabus (.docx or .txt) and ask it anything.<br>Powered by local AI ‚Äî no data leaves your machine.</p>
  </div>

  <!-- SERVER STATUS -->
  <div class="server-status checking" id="server-status">
    <div class="status-dot"></div>
    <span id="status-text">Checking server connection...</span>
  </div>

  <!-- UPLOAD SECTION -->
  <div class="upload-section">
    <div class="section-label">// 01 ‚Äî Upload your syllabus</div>

    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept=".docx,.txt" onchange="handleFileSelect(this.files[0])">
      <div class="drop-icon">üìÑ</div>
      <div class="drop-text">Drop your syllabus here or click to browse</div>
      <div class="drop-subtext">Supports <span>.docx</span> and <span>.txt</span> ‚Äî any course, any university</div>
    </div>

    <!-- upload progress -->
    <div class="upload-progress" id="upload-progress">
      <div class="progress-header">
        <span class="progress-filename" id="progress-filename">‚Äî</span>
        <span class="progress-status" id="progress-status">Uploading...</span>
      </div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div class="progress-steps">
        <span class="progress-step" id="pstep-upload">UPLOAD</span>
        <span>‚Üí</span>
        <span class="progress-step" id="pstep-parse">PARSE</span>
        <span>‚Üí</span>
        <span class="progress-step" id="pstep-chunk">CHUNK</span>
        <span>‚Üí</span>
        <span class="progress-step" id="pstep-embed">EMBED</span>
        <span>‚Üí</span>
        <span class="progress-step" id="pstep-index">INDEX</span>
      </div>
    </div>

    <!-- loaded file banner -->
    <div class="loaded-file" id="loaded-file">
      <div class="file-icon">‚úÖ</div>
      <div class="file-info">
        <div class="file-name" id="loaded-filename">‚Äî</div>
        <div class="file-meta" id="loaded-meta">‚Äî</div>
      </div>
      <button class="change-btn" onclick="resetUpload()">‚Ü∫ CHANGE</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat">
      <span class="stat-value" id="stat-chunks">‚Äî</span>
      <span class="stat-label">Chunks Indexed</span>
    </div>
    <div class="stat">
      <span class="stat-value">384</span>
      <span class="stat-label">Embedding Dims</span>
    </div>
    <div class="stat">
      <span class="stat-value">TinyLlama</span>
      <span class="stat-label">LLM Model</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="stat-queries">0</span>
      <span class="stat-label">Queries Run</span>
    </div>
  </div>

  <!-- Q&A SECTION ‚Äî shown after upload -->
  <div class="qa-section" id="qa-section">

    <div class="suggested">
      <div class="section-label">// 02 ‚Äî Ask anything</div>
      <div class="chips" id="chips">
        <button class="chip" onclick="setQuery(this.textContent)">What is the grading policy?</button>
        <button class="chip" onclick="setQuery(this.textContent)">What textbooks are required?</button>
        <button class="chip" onclick="setQuery(this.textContent)">When are office hours?</button>
        <button class="chip" onclick="setQuery(this.textContent)">What topics does this course cover?</button>
        <button class="chip" onclick="setQuery(this.textContent)">What are the late submission penalties?</button>
        <button class="chip" onclick="setQuery(this.textContent)">What equipment do I need?</button>
      </div>
    </div>

    <div class="query-section">
      <textarea id="query-input" placeholder="Ask anything about your syllabus..." rows="3" oninput="updateChar()"></textarea>
      <div class="query-footer">
        <span class="char-count" id="char-count">0 chars</span>
        <button class="ask-btn" id="ask-btn" onclick="runRAG()">
          <div class="spinner"></div>
          <span class="btn-text">‚ñ∂ ASK</span>
        </button>
      </div>
    </div>

    <div id="result-area">
      <div class="result-header">
        <span class="result-label">// Result</span>
        <div class="pipeline-steps">
          <span class="step" id="step-embed">EMBED</span>
          <span class="step-arrow">‚Üí</span>
          <span class="step" id="step-retrieve">RETRIEVE</span>
          <span class="step-arrow">‚Üí</span>
          <span class="step" id="step-augment">AUGMENT</span>
          <span class="step-arrow">‚Üí</span>
          <span class="step" id="step-generate">GENERATE</span>
        </div>
      </div>
      <div id="answer-container"></div>
      <div id="chunks-container"></div>
    </div>

  </div>

  <!-- HOW IT WORKS -->
  <div class="how-it-works">
    <div class="section-label" style="margin-bottom:20px">// How this RAG pipeline works</div>
    <div class="flow">
      <div class="flow-step">
        <div class="flow-icon">üì§</div>
        <div class="flow-step-name">Upload</div>
        <div class="flow-step-desc">Your syllabus is sent to the local Flask server</div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">‚úÇÔ∏è</div>
        <div class="flow-step-name">Chunk</div>
        <div class="flow-step-desc">Document split into overlapping text segments</div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">üî¢</div>
        <div class="flow-step-name">Embed</div>
        <div class="flow-step-desc">Each chunk encoded as a 384-dim vector</div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">üîç</div>
        <div class="flow-step-name">Retrieve</div>
        <div class="flow-step-desc">Top-k nearest chunks found via L2 similarity</div>
      </div>
      <div class="flow-step">
        <div class="flow-icon">ü§ñ</div>
        <div class="flow-step-name">Generate</div>
        <div class="flow-step-desc">TinyLlama answers using only retrieved context</div>
      </div>
    </div>
  </div>

</div>

<script>
const API = "http://localhost:5000";
let queryCount = 0;
let serverOnline = false;
let docReady = false;

// ---- server health check ----
async function checkServer() {
  try {
    const res = await fetch(`${API}/health`);
    const data = await res.json();
    serverOnline = true;
    document.getElementById("server-status").className = "server-status online";

    if (data.ready && data.filename) {
      // server already has a document loaded (e.g. passed via command line arg)
      document.getElementById("status-text").textContent =
        `Server online ¬∑ ${data.filename} loaded ¬∑ ${data.chunks_indexed} chunks indexed`;
      showDocReady(data.filename, data.chunks_indexed);
    } else {
      document.getElementById("status-text").textContent =
        "Server online ‚Äî upload your syllabus to get started";
    }
  } catch {
    serverOnline = false;
    document.getElementById("server-status").className = "server-status offline";
    document.getElementById("status-text").textContent =
      "Server offline ‚Äî run: python app.py in your project folder";
  }
}

checkServer();
setInterval(checkServer, 6000);

// ---- drag and drop ----
const dropZone = document.getElementById("drop-zone");

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));

dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  const file = e.dataTransfer.files[0];
  if (file) handleFileSelect(file);
});

// ---- file upload ----
async function handleFileSelect(file) {
  if (!file) return;

  if (!serverOnline) {
    alert("Server is offline. Start it with: python app.py");
    return;
  }

  const ext = file.name.split(".").pop().toLowerCase();
  if (!["docx", "txt"].includes(ext)) {
    alert("Only .docx and .txt files are supported.");
    return;
  }

  // show progress UI
  document.getElementById("upload-progress").style.display = "block";
  document.getElementById("loaded-file").classList.remove("visible");
  document.getElementById("progress-filename").textContent = file.name;
  document.getElementById("qa-section").classList.remove("visible");
  document.getElementById("result-area").style.display = "none";

  // animate upload steps
  const steps = ["pstep-upload", "pstep-parse", "pstep-chunk", "pstep-embed", "pstep-index"];
  steps.forEach(s => document.getElementById(s).className = "progress-step");

  async function activateStep(id, barPct, statusText) {
    document.getElementById(id).className = "progress-step active";
    document.getElementById("progress-bar").style.width = barPct + "%";
    document.getElementById("progress-status").textContent = statusText;
    await new Promise(r => setTimeout(r, 300));
  }

  await activateStep("pstep-upload", 10, "Uploading...");

  // build form data and send to flask
  const formData = new FormData();
  formData.append("file", file);

  try {
    // animate remaining steps while waiting for server
    activateStep("pstep-parse", 25, "Parsing document...");
    setTimeout(() => activateStep("pstep-chunk", 45, "Chunking text..."), 600);
    setTimeout(() => activateStep("pstep-embed", 65, "Embedding chunks..."), 1200);
    setTimeout(() => activateStep("pstep-index", 85, "Building FAISS index..."), 1800);

    const res = await fetch(`${API}/upload`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (data.error) {
      document.getElementById("progress-status").textContent = "Error: " + data.error;
      document.getElementById("progress-bar").style.background = "var(--error)";
      return;
    }

    // success!
    steps.forEach(s => document.getElementById(s).className = "progress-step done");
    document.getElementById("progress-bar").style.width = "100%";
    document.getElementById("progress-status").textContent = "Ready!";

    await new Promise(r => setTimeout(r, 500));
    document.getElementById("upload-progress").style.display = "none";

    showDocReady(data.filename, data.chunks);

  } catch (err) {
    document.getElementById("progress-status").textContent = "Upload failed: " + err.message;
  }
}

function showDocReady(filename, chunkCount) {
  docReady = true;

  // show loaded file banner
  document.getElementById("loaded-file").classList.add("visible");
  document.getElementById("loaded-filename").textContent = filename;
  document.getElementById("loaded-meta").textContent = `${chunkCount} chunks indexed and ready`;
  document.getElementById("stat-chunks").textContent = chunkCount;

  // show Q&A section
  document.getElementById("qa-section").classList.add("visible");

  // scroll to Q&A
  setTimeout(() => {
    document.getElementById("qa-section").scrollIntoView({ behavior: "smooth", block: "start" });
  }, 200);
}

function resetUpload() {
  docReady = false;
  document.getElementById("loaded-file").classList.remove("visible");
  document.getElementById("upload-progress").style.display = "none";
  document.getElementById("qa-section").classList.remove("visible");
  document.getElementById("result-area").style.display = "none";
  document.getElementById("stat-chunks").textContent = "‚Äî";
  document.getElementById("file-input").value = "";

  // reset progress bar
  document.getElementById("progress-bar").style.width = "0%";
  document.getElementById("progress-bar").style.background = "var(--accent)";
}

// ---- Q&A ----
function setQuery(text) {
  document.getElementById("query-input").value = text;
  updateChar();
  document.getElementById("query-input").focus();
}

function updateChar() {
  const len = document.getElementById("query-input").value.length;
  document.getElementById("char-count").textContent = len + " chars";
}

async function animateStep(stepId, delay) {
  return new Promise(resolve => {
    setTimeout(() => {
      document.querySelectorAll(".step").forEach(s => {
        if (s.id !== stepId && s.classList.contains("active")) {
          s.classList.remove("active");
          s.classList.add("done");
        }
      });
      document.getElementById(stepId).classList.add("active");
      resolve();
    }, delay);
  });
}

async function runRAG() {
  const question = document.getElementById("query-input").value.trim();
  if (!question) return;

  if (!serverOnline) {
    alert("Server is offline. Start it with: python app.py");
    return;
  }

  if (!docReady) {
    alert("Please upload a syllabus first.");
    return;
  }

  const btn = document.getElementById("ask-btn");
  btn.disabled = true;
  btn.classList.add("loading");

  document.querySelectorAll(".step").forEach(s => s.classList.remove("active", "done"));
  document.getElementById("result-area").style.display = "block";
  document.getElementById("answer-container").innerHTML = "";
  document.getElementById("chunks-container").innerHTML = "";

  animateStep("step-embed", 0);
  animateStep("step-retrieve", 600);
  animateStep("step-augment", 1200);
  animateStep("step-generate", 1800);

  try {
    const res = await fetch(`${API}/ask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question })
    });

    const data = await res.json();

    document.querySelectorAll(".step").forEach(s => {
      s.classList.remove("active");
      s.classList.add("done");
    });

    if (data.error) {
      document.getElementById("answer-container").innerHTML =
        `<div class="error-msg">‚ö† ${data.error}</div>`;
    } else {
      document.getElementById("answer-container").innerHTML = `
        <div class="answer-card">
          <div class="answer-text">${data.answer}</div>
        </div>`;

      const chunksHTML = `
        <div>
          <button class="chunks-toggle" onclick="toggleChunks(this)">
            <span class="arrow">‚ñ∂</span> VIEW RETRIEVED CHUNKS (${data.chunks.length})
          </button>
          <div class="chunks-list">
            ${data.chunks.map((c, i) => {
              const pct = Math.max(10, Math.min(100, Math.round(100 - c.score * 5)));
              return `
              <div class="chunk-card">
                <div class="chunk-meta">
                  <span class="chunk-num">CHUNK #${c.index + 1}</span>
                  <div class="similarity-bar">
                    <span>similarity</span>
                    <div class="bar-track"><div class="bar-fill" style="width:0%" data-pct="${pct}"></div></div>
                    <span>${pct}%</span>
                  </div>
                </div>
                <div class="chunk-text">${c.text.substring(0, 200)}${c.text.length > 200 ? "..." : ""}</div>
              </div>`;
            }).join("")}
          </div>
        </div>`;
      document.getElementById("chunks-container").innerHTML = chunksHTML;
    }

    queryCount++;
    document.getElementById("stat-queries").textContent = queryCount;
    document.getElementById("result-area").scrollIntoView({ behavior: "smooth", block: "nearest" });

  } catch (err) {
    document.getElementById("answer-container").innerHTML =
      `<div class="error-msg">‚ö† Error: ${err.message}</div>`;
  }

  btn.disabled = false;
  btn.classList.remove("loading");
}

function toggleChunks(btn) {
  btn.classList.toggle("open");
  const list = btn.nextElementSibling;
  list.classList.toggle("visible");
  if (list.classList.contains("visible")) {
    setTimeout(() => {
      list.querySelectorAll(".bar-fill").forEach(bar => {
        bar.style.width = bar.dataset.pct + "%";
      });
    }, 50);
  }
}

document.getElementById("query-input").addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    runRAG();
  }
});
</script>
</body>
</html>
